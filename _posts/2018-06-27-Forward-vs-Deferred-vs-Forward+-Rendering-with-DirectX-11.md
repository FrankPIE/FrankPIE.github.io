---
layout: post
title: (译)前向渲染VS延迟渲染VS前向+渲染使用DX11实现
subtitle: (译)前向渲染VS延迟渲染VS前向+渲染使用DX11实现
tags: 
    - 渲染算法
    - 计算机图形学
description: >
    比较前向渲染，延迟渲染和Tiled Base的前向+渲染的区别以及如何用DX11去实现
hero: /hero/gpu.jpg
overlay: blue
published: false
---

# [译] 前向渲染 VS 延迟渲染 VS 前向+渲染

在这篇文章中，我将会分析和比较三种不同的渲染算法：

1. 前向渲染

2. 延迟着色

3. 前向+（Tied Base的前向渲染）

## 目录

[toc]

## 简介

**前向渲染**工作方式是在场景中光栅化每个几何对象。在着色过程中，通过遍历场景中的光源来决定如何点亮几何对象。这意味这每个几何对象爱那个必须去考虑场景中的每个光源。当然，我们可以通过丢弃不可见的或者被遮挡的几何集合对象来实现优化。我们还可以通过丢弃不可见光照来进一步优化。如果光照的范围是已知的，那么我们还可以在渲染几何对象之前执行对三角锥裁剪。3D对象裁切和光照锥裁切
提供了有限的优化手段并且光照裁切通常是不会被实现的。当使用前向渲染管线时。更多的是使用限制可影响场景物体的光照数量来进行优化。举个例子，一些图形引擎会对物体最接近的两到三个光源进行执行逐像素光照而对于次一级接近的三到四个光源进行逐顶点光照。在OpenGL和DX提供的传统固定渲染管线中激活的动态光源限制数量为8。在现代图形硬件下，前向渲染管线的限制数量大约是100个动态场景光照，否则就可能会出现明显的帧率下降问题。

另外一方面**延迟渲染**的工作方式是光栅化每个场景对象（不包括光照）写入一个2D图像缓存中存储几何信息用来在之后的Pass中计算光照。存储在2D图像缓存中的是：

* 屏幕空间深度
* 平面法线
* 漫反射颜色
* 高光颜色和高光权重

这些2D图像的组合就是几何缓存（或者叫G-Buffer）[1]

虽然其他信息要用于计算光照也可以被存成进图像缓存，但是要注意对于HD（1080p）和每像素32位的G-buffer纹理来说至少需要8.29MB的纹理内存。

在G-buffer生成了之后，这些几何信息经常在照明过程中用来计算光照信息。照明过程通过将每个光源渲染为场景中的几何对象来执行。每个像素被灯光的几何信息所影响并使用光照渲染方程进行着色。

延迟渲染相对于前向渲染最明显的优势就是把性能消耗昂贵的灯光计算控制在每个灯光对于齐覆盖的像素只需要计算一次。对于现代图形硬件来说，延迟渲染技术可以对HD（1080p）分辨率支持大约2500个动态光照而不会造成明显的帧率下降。

延迟渲染也有个明显的缺陷那就是只有不透明的物体可以被光栅进G-buffers。原因是多个透明的物体可能覆盖相同的屏幕空间像素但是对于G-Buffers中的每个像素来说只能存储一个值。在光照过程中，需要对深度值，法线，漫反射和高光颜色进行采样用以当前的屏幕空间像素被着色。由于只有一个值供每个G-Buffer进行采样，所以光照过程无法支持透明物体
的渲染。为了绕过这个问题，透明集合体必须使用标准前向渲染技术用来渲染，这样也限制了场景中透明物体数量或者动态光源的数量。一个场景如果只考虑不透明物体那么就可以保证大约200个动态光源而不会出现帧率下降等问题。

另外一个延迟渲染的缺陷就是在一次光照Pass中只有一个光照模型可以被模拟，这是由于在一次pass中你只能绑定唯一一个像素着色器。这对于渲染管线来说通常不算是问题因为正常情况下只有一个像素着色器，然而如果你的渲染流水线拥有多个不同的光照模型，那么在延迟渲染中就会出现需要切换渲染流水线的问题。

前向+(也就是TBR)是必须在着色过程中考虑使用分块光照裁剪算法减少灯光数量的前向渲染技术。前向+主要考虑两个阶段：

1. 光源裁剪

2. 前向渲染

前向+渲染技术的第一个过程是在屏幕空间中使用一致的分块网格来分割灯光到不同的块中。

由于在之前的一个过程中已经用屏幕空间像素的位置去寻找灯光列表而预计算了着色，所以这个过程是采用了标准前向渲染而替换了其中循环每个灯光来计算每个物体的着色的部分。灯光的裁剪相比标准的前向渲染由于减少了多余的灯光迭代从而明显的提升了性能。不管是不透明还是透明几何体可以统一的管理而不会明显的丢失性能，而且多材质和多光照模型在前向+渲染中是原生支持的。

自从前向+渲染整合了标准前向渲染技术，前向+渲染技术可以融合目前存在的前向渲染图形引擎。前向+不使用G-Buffer而且没有延迟渲染的限制。不管是透明的还是不透明的物体都能使用前向+渲染管线进行渲染。在现代的图形硬件中，一个场景可以考虑大约5000-6000个动态光源。

在这篇文章中，我将会描述如何实现这三种渲染技术：

1. 前向渲染
2. 延迟渲染
3. 前向+渲染（Tied-Base 前向渲染）

我也将会给出性能参数来试着给出在哪种条件下一种技术更加具有优势。

### 定义

在整个文章中，定义一些术语让这篇文章更加易于理解是挺重要的一件事。如果你相当熟悉一些基础的图形学术语，那么你也许可以跳过这个部分。

**场景**指的是一个物体的可渲染嵌套层次结构。举个例子，所有的静态物体可以被作为一组物体打包被渲染。每个独立的可渲染的物体在场景中用**场景节点**表示。每个场景节点表示一个可渲染物体（比如一个网格），整个场景可以用一个最顶层节点来表示称为**根节点**。场景中的场景节点的连通性也称为**场景图**。由于根节点也是一个场景节点，所以场景可以嵌套产生更多复杂的由动态或者静态物体组成的场景图。

**过程（pass）**表示一个单独的操作用以执行渲染技术中的一步。举个例子，**不透明物体渲染过程（opaque pass）**是一个遍历场景中所有物体并且渲染其中不透明物体的过程。**透明物体渲染过程（transparent pass）**就是遍历场景中所有物体但是只渲染其中的透明物体。一个过程也可以是普通的操作比如拷贝GPU资源或者调用一个通用计算着色器。

**技术（technique）**意思是组合了多个过程（Passes）并按照一定顺序执行来实现渲染算法。

**管线状态（pipeline state）**表示在一个物体被渲染之前渲染管线的配置。管道状态对象封装下列渲染状态：

* 着色器（顶点着色器，曲面细分着色器，几何着色器和像素着色器，）

* 光栅化（多边形填充模式，剔除模式，裁剪剔除，视口）

* 混合阶段

* 深度/模版

* 渲染目标

虽然DX12介绍了一个管线状态对象，但是我的管道状态定义与DX12稍有所不同。

前向渲染是一种传统的渲染技术只有两个过程：

1. 不透明物体渲染过程
2. 透明物体渲染过程

**不透明物体渲染过程**将会从前到后（相对于摄像机）渲染场景中所有不透明物体，这样可以尽可能减少多余绘制。在该过程中，不需要执行任何混合操作。

**透明物体渲染过程**将会从后往前（相对于摄像机）渲染所有透明物体，这样可以确保混合将会正确被执行。在该过程中，透明混合需要打开从而允许半透明材质在像素被渲染到渲染目标时可以被正确混合。

在前向渲染过程中，所有的光照过程和其他所有材质着色指令都在像素着色器中一起被执行。

**延迟渲染**表示考虑三个主要过程的渲染技术：

1. 几何过程
2. 光照过程
3. 透明处理过程

第一个过程是**几何过程**，这个过程和前向渲染技术的不透明物体渲染过程非常相似，因为只有不透明物体会在这个过程中被渲染。区别在于在这个过程中不会执行任何光照计算却会输出几何和材质数据到**G-buffer**，就像我在简介中介绍的那样。

在**光照过程**中，代表几何体积的灯光被渲染到场景中并且材质信息被存储在G—buffer中用于计算已经被光栅化的像素的光照。

最后的过程是**透明处理过程**。这个过程和前向渲染技术中的透明物体渲染过程一致。由于延迟渲染原生不支持透明材质，透明物体的渲染必须又一个独立的过程并且要使用标准的前向渲染方法。

**前向+渲染**（也可以称作**Tiled 前向**）

## 前向渲染

### 顶点着色器

### 像素着色器

#### 材质

#### 纹理

#### 灯光

### 像素着色器进阶

#### 材质类型

##### 漫反射

##### 不透明

##### 环境光与散射

##### 高光权重

##### 法线

##### 法线贴图

##### 凹凸贴图

#### 光照类型

##### 漫反射光

##### 高光

##### 衰减

##### 点光

##### 聚光灯

##### 直接光

#### 最终着色

## 延迟着色

### G-Buffer Pass

#### G-Buffer布局

##### 深度/模版Buffer

##### 光累积Buffer

##### 漫反射Buffer

##### 高光Buffer

##### 法线Buffer

##### 布局摘要

#### 像素着色器

### 光照Pass（Guerrilla实现）

#### 决定发光的像素

##### 标记像素

##### 像素计数

#### 像素着色处理

### 光照Pass（我的实现）

#### 不标记像素

#### 像素着色处理

#### 像素着色器

### 透明度Pass

## 前向+渲染

### 三角锥网格

### 三角锥网格通用计算着色器

#### 在屏幕空间中角落贴片

#### 在可视空间中角落贴片

#### 计算三角锥平面

#### 存储三角锥网格

### 光照裁剪

#### 计算最大/最小深度值

#### 光照列表数据结构

### 三角锥裁剪

#### 三角锥-球裁剪

#### 三角锥-圆锥裁剪

### 光裁剪通用计算着色器

### 最终着色操作

## 实验装置和性能测试结果

### 前向渲染性能

#### 大光照数量

#### 小光照数量

### 延迟渲染性能

#### 大光照数量

#### 小光照数量

### 前向+渲染性能

#### 大光照数量

#### 小光照数量

### 技术比较

#### 大光照数量

#### 小光照数量

## 未来展望

### 一般注意事项

### 前向渲染

### 延迟渲染

### 分块前向渲染

## 结论

## Demo下载

## 引用
